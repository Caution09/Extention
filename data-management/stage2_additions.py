#!/usr/bin/env python3
# -*- coding: utf-8 -*-

def main():
    try:
        # 追加希望.tsvを読み込み
        with open('追加希望.tsv', 'r', encoding='utf-8') as f:
            wish_lines = f.readlines()
        
        # 第2段階: 表情・服装系の項目を分類
        stage2_items = []
        remaining_items = []
        
        # 表情・服装関連キーワードのマッピング
        expression_clothing_keywords = {
            # 表情・感情
            '驚き': ('表情・感情', 'ポジティブな感情'),
            '怒る': ('表情・感情', 'ネガティブな感情'),
            '泣き顔': ('表情・感情', 'ネガティブな感情'),
            '涙目': ('表情・感情', 'ネガティブな感情'),
            '涙袋': ('表情・感情', 'その他'),
            '涙の筋': ('表情・感情', 'ネガティブな感情'),
            '照れ笑い': ('表情・感情', '恥ずかしい表情'),
            '恥ずかしい顔': ('表情・感情', '恥ずかしい表情'),
            '恥かしい': ('表情・感情', '恥ずかしい表情'),
            '羞恥': ('表情・感情', '恥ずかしい表情'),
            '嫌がる': ('表情・感情', 'ネガティブな感情'),
            '嫌悪': ('表情・感情', 'ネガティブな感情'),
            '呆れる': ('表情・感情', 'ネガティブな感情'),
            '呆れ': ('表情・感情', 'ネガティブな感情'),
            '困惑': ('表情・感情', '困惑した表情・感情'),
            '我慢': ('表情・感情', '真剣な表情・感情'),
            '我慢の表情': ('表情・感情', '真剣な表情・感情'),
            'がまん': ('表情・感情', '真剣な表情・感情'),
            'ガマン': ('表情・感情', '真剣な表情・感情'),
            '耐える': ('表情・感情', '真剣な表情・感情'),
            '苦しい': ('表情・感情', 'ネガティブな感情'),
            '苦': ('表情・感情', 'ネガティブな感情'),
            '痛い': ('表情・感情', 'ネガティブな感情'),
            '不安': ('表情・感情', 'ネガティブな感情'),
            '焦る': ('表情・感情', 'ネガティブな感情'),
            '興奮': ('表情・感情', 'ポジティブな感情'),
            '情熱': ('表情・感情', 'ポジティブな感情'),
            '恍惚': ('表情・感情', '性的な表情'),
            '絶頂': ('表情・感情', '性的な表情'),
            '感じる': ('表情・感情', '性的な表情'),
            'あえぎ': ('表情・感情', '性的な表情'),
            '失神': ('表情・感情', '暗い表情'),
            '脱力': ('表情・感情', 'リラックス'),
            '意識が遠のく': ('表情・感情', '暗い表情'),
            '意識が飛ぶ': ('表情・感情', '暗い表情'),
            '意識を失う': ('表情・感情', '暗い表情'),
            '力が抜ける': ('表情・感情', 'リラックス'),
            '虚ろ': ('表情・感情', '暗い表情'),
            '敗北': ('表情・感情', 'ネガティブな感情'),
            'ドンびく': ('表情・感情', 'ネガティブな感情'),
            'ドン引く': ('表情・感情', 'ネガティブな感情'),
            '引きつく': ('表情・感情', 'ネガティブな感情'),
            '引きついた': ('表情・感情', 'ネガティブな感情'),
            'shy': ('表情・感情', '恥ずかしい表情'),
            'sad': ('表情・感情', 'ネガティブな感情'),
            'despair': ('表情・感情', 'ネガティブな感情'),
            'horrified': ('表情・感情', 'ネガティブな感情'),
            'crying': ('表情・感情', 'ネガティブな感情'),
            'sobbing': ('表情・感情', 'ネガティブな感情'),
            'sexy': ('表情・感情', '性的な表情'),
            'orgasm': ('表情・感情', '性的な表情'),
            
            # 顔の詳細
            '白目': ('顔', '目'),
            '薄目': ('顔', '目'),
            '片目': ('顔', '目'),
            '目線': ('顔', '目'),
            '横目': ('顔', '目'),
            '口角': ('顔', '口'),
            '歯': ('顔', '歯'),
            '歯ブラシ': ('オブジェクト', '日用品'),
            '歯を磨く': ('動作', 'しぐさ'),
            '唇': ('顔', '口'),
            '鼻水': ('顔', '鼻'),
            'のどちんこ': ('顔', '口'),
            '犬歯': ('顔', '歯'),
            'eye': ('顔', '目'),
            'teeth': ('顔', '歯'),
            'lips': ('顔', '口'),
            
            # 髪・髪型関連
            '髪型': ('髪', '髪の長さ'),
            '髪をまとめる': ('動作', '衣服'),
            '髪を結う': ('動作', '衣服'),
            '髪を結ぶ': ('動作', '衣服'),
            '髪をいじる': ('動作', 'しぐさ'),
            '髪がかかる': ('髪', '動き'),
            '髪の毛かき': ('動作', 'しぐさ'),
            'うしろ髪': ('髪', '髪の長さ'),
            '分け目': ('髪', '髪のオプション'),
            'もみあげ': ('髪', '髪のオプション'),
            'もみ上げ': ('髪', '髪のオプション'),
            'うさみみ': ('装飾', '耳'),
            'ケモミミ': ('装飾', '耳'),
            'ツインテル': ('髪', '女性向けの髪型'),
            'セミロングヘア': ('髪', '髪の長さ'),
            'みつあみ': ('髪', '女性向けの髪型'),
            'シニョン': ('髪', '女性向けの髪型'),
            'マロまゆ': ('顔', '眉'),
            'マロ': ('顔', '眉'),
            '毛量': ('髪', '髪質'),
            'ゆるふわ': ('髪', '髪質'),
            '髪 複雑': ('髪', '髪質'),
            '髪　複雑': ('髪', '髪質'),
            
            # 装飾・アクセサリー
            'マフラー': ('装飾', 'その他'),
            'ヘアバンド': ('装飾', 'ヘアアクセサリー'),
            'へそピアス': ('装飾', '下半身'),
            'ホクロ': ('装飾', 'その他'),
            'そばかす': ('装飾', 'その他'),
            'キスマーク': ('装飾', 'その他'),
            'ガータベルト': ('装飾', '下半身'),
            'アクセ': ('装飾', 'アクセサリー'),
            '花かんむり': ('装飾', 'ヘアアクセサリー'),
            'アイマスク': ('装飾', '上半身'),
            'アイライン': ('装飾', 'メイク'),
            '口紅': ('装飾', 'メイク'),
            '結婚指輪': ('装飾', '手'),
            '名札': ('装飾', '上半身'),
            '手形': ('装飾', '手'),
            'wrist scrunchie': ('装飾', '手'),
            
            # 服装関連
            '制服': ('服装', '制服'),
            '勝負服': ('服装', '一式'),
            '学校の体操着': ('服装', '制服'),
            'セイラー服': ('服装', '制服'),
            'チャイナドレス': ('服装', 'ドレス'),
            'チーパオ': ('服装', 'ドレス'),
            'ワンピース': ('服装', 'ドレス'),
            'タキシード': ('服装', '一式'),
            'Yシャツ': ('服装', 'トップス'),
            'ランニングシャツ': ('服装', 'トップス'),
            'シャツの裾': ('服装', 'トップス'),
            'シャツを出す': ('動作', '衣服'),
            'トップレス': ('服装', '裸'),
            'ボディコン': ('服装', 'ドレス'),
            'キャミ': ('服装', 'トップス'),
            'ガウン': ('服装', 'ドレス'),
            'エプロン': ('服装', 'オプション'),
            '前掛け': ('服装', 'オプション'),
            '前掛': ('服装', 'オプション'),
            'コルセット': ('服装', 'トップス'),
            'ハイネック': ('服装', 'トップス'),
            '腹巻き': ('服装', 'オプション'),
            'アームカバー': ('服装', '手袋'),
            '燕尾': ('服装', 'オプション'),
            'フェイスベール': ('服装', '頭部'),
            'faceveil': ('服装', '頭部'),
            '顎マスク': ('服装', '頭部'),
            
            # 下着・水着
            'フロントホック': ('服装', '下着'),
            'ブラチラ': ('服装', '下着'),
            'ブラをはずす': ('動作', '衣服'),
            'loose bra': ('服装', '下着'),
            'bra peek': ('服装', '下着'),
            'ニーソックス': ('服装', '靴下'),
            '縞パン': ('服装', '下着'),
            'ノーパン': ('服装', '裸'),
            'パンティーショット': ('服装', '下着'),
            'pantiy': ('服装', '下着'),
            'panty': ('服装', '下着'),
            'buruma aside': ('服装', '下着'),
            'crotchless': ('服装', '下着'),
            'panty gag': ('服装', '下着'),
            'pantieline': ('服装', '下着'),
            '下着姿': ('服装', '下着'),
            'ホットパンツ': ('服装', 'ボトムス'),
            
            # 靴・履物
            'ローファー': ('服装', '靴'),
            'カウボーイブーツ': ('服装', '靴'),
            'サンダル': ('服装', '靴'),
            '上履き': ('服装', '靴'),
            '足袋': ('服装', '靴下'),
            '踵': ('身体', '足'),
            '下駄箱': ('場所', '学校（室内）'),
            'げた箱': ('場所', '学校（室内）'),
            'shoe box': ('場所', '学校（室内）'),
            '靴を脱ぐ': ('動作', '衣服'),
            
            # 特殊衣装・コスプレ
            '女装': ('服装', '一式'),
            'バニー': ('コスチューム', '動物'),
            '褌': ('服装', '下着'),
            '半被': ('服装', 'アウター'),
            '甲冑': ('服装', '防具'),
            'ミリタリーロリィタ': ('服装', '一式'),
            'ミリタリーロリータ': ('服装', '一式'),
            'スリングショット': ('服装', '水着'),
            'bondage outfit': ('服装', '一式'),
            'Tribalwear': ('服装', '一式'),
            
            # 柄・模様・色
            'パステル': ('色', '色'),
            '暖色': ('色', '色'),
            'ヒョウ柄': ('模様', '柄（動物）'),
            'パンサープリント': ('模様', '柄（動物）'),
            '水玉模様のコットンパンティー': ('模様', '柄'),
            '単色': ('色', '色'),
            '黒塗り': ('色', '黒系'),
            '黒線': ('色', '黒系'),
            '黒帯': ('色', '黒系'),
            '黒タイツ': ('服装', '靴下'),
            'ぴちぴち': ('修飾語', '形状'),
            'ピチピチ': ('修飾語', '形状'),
            '透け': ('修飾語', '材質'),
            '透ける': ('修飾語', '材質'),
            
            # その他の外観
            '着衣': ('服装', '一般'),
            '衣類': ('服装', '一般'),
            '普段着': ('服装', '一般'),
            '乱れた服': ('服装', '状態'),
            'shirt pull': ('動作', '衣服'),
            'wearing clothes': ('服装', '一般'),
            'clothed female': ('服装', '一般'),
            '着用': ('動作', '衣服'),
            '肩出し': ('服装', '露出度'),
        }
        
        # 処理済み項目
        processed_items = set()
        
        # 各行をチェックして分類
        for line in wish_lines:
            line = line.strip()
            if not line:
                continue
                
            parts = line.split('\t')
            if len(parts) >= 4:
                大項目_orig = parts[0]
                中項目_orig = parts[1]
                小項目 = parts[2]
                prompt = parts[3]
            elif len(parts) == 3:
                大項目_orig = ""
                中項目_orig = parts[0]
                小項目 = parts[1]
                prompt = parts[2]
            elif len(parts) == 2:
                大項目_orig = ""
                中項目_orig = ""
                小項目 = parts[0]
                prompt = parts[1]
            else:
                continue
            
            # キーワードマッチング
            matched = False
            for keyword, (大項目, 中項目) in expression_clothing_keywords.items():
                if keyword in 小項目 or keyword in prompt:
                    stage2_items.append(f"{大項目}\t{中項目}\t{小項目}\t{prompt}")
                    processed_items.add(小項目)
                    matched = True
                    break
            
            if not matched:
                remaining_items.append(line)
        
        print(f"第2段階: {len(stage2_items)}個の項目を抽出しました")
        
        # マスターデータに追加
        if stage2_items:
            with open('マスターデータ.tsv', 'a', encoding='utf-8') as f:
                for item in stage2_items:
                    f.write(item + '\n')
            print(f"マスターデータに{len(stage2_items)}個の項目を追加しました")
        
        # 残り項目を追加希望.tsvに書き戻し
        with open('追加希望.tsv', 'w', encoding='utf-8') as f:
            for item in remaining_items:
                f.write(item + '\n')
        
        print(f"残り項目数: {len(remaining_items)}")
        
    except Exception as e:
        print(f"エラーが発生しました: {e}")

if __name__ == "__main__":
    main()