# Prompt Generator リファクタリング計画書

## 現在のフォルダ構成

```
E:\Project\Extension\Prompt
│  manifest.json          # Chrome拡張機能の設定ファイル
│  popup.html            # メインのポップアップ画面
│  popup.css             # ポップアップのスタイル
│  prompt.html           # プロンプト名入力用の小窓
│  error.html            # エラー表示用の小窓
│  Prompt.code-workspace # VSCodeのワークスペース設定
│
├─assets/
│  ├─icon/               # アイコンファイル
│  │      Icon.png       # 32x32 アイコン
│  │      Icon64.png     # 64x64 アイコン
│  │      Icon128.png    # 128x128 アイコン
│  │
│  └─master/             # マスターデータ（リファクタ対象外）
│          default-master.js       # プロンプトのデフォルトデータ
│          default-master-dummy.js # ダミーデータ
│
├─js/
│  │  background.js      # Service Worker（拡張機能のバックグラウンド処理）
│  │  main.js           # ポップアップのメインスクリプト（旧popup_script.js）
│  │  prompt.js         # prompt.html用のスクリプト
│  │
│  └─modules/           # リファクタリング対象のモジュール
│          api-client.js        # API通信処理（旧webApi-script.js）
│          category-manager.js  # カテゴリー管理（旧categoryData.js）
│          data-manager.js      # データ管理（旧globalData-script.js）
│          prompt-editor.js     # プロンプト編集機能（旧editPrompt-script.js）
│          storage.js          # Chrome Storage APIラッパー（新規作成）
│
└─lib/                   # 外部ライブラリ
        jquery-3.5.1.js  # jQuery本体
        jquery-ui.js     # jQuery UI

```

## 各ファイルの役割

### HTML ファイル

- **popup.html**: 拡張機能のメイン画面。検索、辞書、編集の 3 つのタブを持つ
- **prompt.html**: コンテキストメニューから呼ばれる名前入力用ダイアログ
- **error.html**: エラーメッセージ表示用

### コアスクリプト

- **background.js**:

  - コンテキストメニューの管理
  - 他のサイトとの連携処理
  - Chrome API を使用したバックグラウンド処理

- **main.js** (旧 popup_script.js):

  - UI の初期化とイベントハンドリング
  - 各モジュールの統合
  - タブ切り替えなどの UI 制御

- **prompt.js**:
  - prompt.html 専用のスクリプト
  - 入力値を background.js に送信

### モジュール（リファクタリング対象）

#### 1. data-manager.js（旧 globalData-script.js）

**現在の問題点**:

- 多数のグローバル変数が散在
- データの保存/読み込みが各所に分散
- 関数の責務が不明確

**主な機能**:

- プロンプトデータの管理
- アーカイブリストの管理
- 設定データの管理

#### 2. prompt-editor.js（旧 editPrompt-script.js）

**現在の問題点**:

- オブジェクト形式で実装されているが、クラス化した方が良い
- 重み付け処理が複雑

**主な機能**:

- プロンプトの解析と生成
- 要素の追加/削除/並び替え
- StableDiffusion/NovelAI 形式の変換

#### 3. api-client.js（旧 webApi-script.js）

**現在の問題点**:

- エラーハンドリングが不十分
- 非同期処理の扱いが統一されていない

**主な機能**:

- Google Apps Script API との通信
- 翻訳 API（Google/DeepL）の呼び出し
- マスターデータの更新

#### 4. category-manager.js（旧 categoryData.js）

**現在の問題点**:

- データ構造が複雑
- DOM 操作が混在

**主な機能**:

- カテゴリーデータの管理
- datalist の動的生成
- 検索用インデックスの構築

#### 5. storage.js（新規作成）

**目的**:

- Chrome Storage API の抽象化
- 非同期処理の統一
- エラーハンドリングの一元化

## リファクタリング計画

### Phase 1: 基盤整備

#### 1.1 storage.js の実装

```javascript
// Chrome Storage APIのラッパー
const Storage = {
  async get(keys) {
    return new Promise((resolve) => {
      chrome.storage.local.get(keys, resolve);
    });
  },

  async set(items) {
    return new Promise((resolve) => {
      chrome.storage.local.set(items, resolve);
    });
  },

  async remove(keys) {
    return new Promise((resolve) => {
      chrome.storage.local.remove(keys, resolve);
    });
  },

  async clear() {
    return new Promise((resolve) => {
      chrome.storage.local.clear(resolve);
    });
  },
};
```

#### 1.2 グローバル変数の整理

- すべてのグローバル変数を名前空間に統合
- ストレージアクセスを storage.js 経由に統一

### Phase 2: コード品質改善

#### 2.1 重複コードの削除

- UI 生成関数の統合
- リスト生成処理の共通化
- イベントハンドラーの整理

#### 2.2 エラーハンドリングの改善

- try-catch の追加
- ユーザーへの適切なフィードバック
- ログ出力の統一

### Phase 3: 構造改善

#### 3.1 PromptEditor のクラス化

```javascript
class PromptEditor {
  constructor() {
    this.prompt = "";
    this.elements = [];
    this.mode = "SD"; // SD, NAI, None
  }

  parse(promptString) { ... }
  generate() { ... }
  addElement(element) { ... }
  removeElement(index) { ... }
  updateWeight(index, weight) { ... }
}
```

#### 3.2 イベント駆動への移行

- カスタムイベントの導入
- コンポーネント間の疎結合化

### Phase 4: 最適化（オプション）

#### 4.1 jQuery 依存の削減

- 必要最小限の使用に留める
- Vanilla JS で十分な部分は置き換え

#### 4.2 パフォーマンス改善

- DOM 操作の最適化
- 大量データ処理の効率化

## 成功指標

1. **コードの可読性向上**

   - グローバル変数の 90%削減
   - 関数の平均行数を 20 行以下に

2. **保守性の改善**

   - 単一責任原則の遵守
   - テスト可能な構造

3. **バグの削減**
   - エラーハンドリングの網羅
   - 型安全性の向上（JSDoc コメント追加）

## 注意事項

- **後方互換性の維持**: ユーザーの既存データを破壊しない
- **段階的な移行**: 一度に全てを変更しない
- **動作確認の徹底**: 各フェーズ後に全機能をテスト
- **Git での管理**: 各フェーズをブランチで管理

## タイムライン

- Week 1-2: Phase 1（基盤整備）
- Week 3-4: Phase 2（コード品質改善）
- Week 5-6: Phase 3（構造改善）
- Week 7+: Phase 4（最適化）※必要に応じて

各フェーズの完了時にコミット・タグ付けを行い、問題があれば即座に戻せるようにする。
